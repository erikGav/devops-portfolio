elasticsearch:
  global:
    kibanaEnabled: true
  enabled: true
  security:
    existingSecret: elasticsearch-master-credentials
    tls:
      restEncryption: true
      autoGenerated: true
  master:
    masterOnly: false
    replicaCount: 1
  data:
    replicaCount: 0
  coordinating:
    replicaCount: 0
  ingest:
    replicaCount: 0

kibana:
  elasticsearch:
    security:
      auth:
        enabled: true
        elasticsearchPasswordSecret: elasticsearch-master-credentials
      tls:
        enabled: true
        existingSecret: elasticsearch-coordinating-crt
        usePemCerts: true

fluent-bit:
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  enabled: true
  logLevel: info
  env:
    - name: ELASTICSEARCH_PASSWORD
      valueFrom:
        secretKeyRef:
          name: elasticsearch-master-credentials
          key: ELASTIC_PASSWORD

  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 150m
      memory: 256Mi

  config:
    service: |
      [SERVICE]
          Daemon Off
          Flush 1
          Log_Level debug
          Parsers_File /fluent-bit/etc/parsers.conf
          Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
          HTTP_Server On
          HTTP_Listen 0.0.0.0
          HTTP_Port 2020
          Health_Check On
          Trace_Error On

    inputs: |
      [INPUT]
          Name tail
          Path /var/log/containers/chat-app-chat-app*.log
          multiline.parser cri, docker
          Tag kube.*
          DB /var/log/flb_chatapp.db
          Mem_Buf_Limit 100MB
          Skip_Long_Lines On
          Buffer_Chunk_Size 32k
          Buffer_Max_Size 256k
          Refresh_Interval 10

    filters: |
      [FILTER]
          Name kubernetes
          Match kube.*
          Kube_Tag_Prefix kube.var.log.containers.
          Merge_Log On
          Keep_Log Off
          K8S-Logging.Parser On
          K8S-Logging.Exclude On
          Annotations Off
          Labels On

    customParsers: |
      [PARSER]
          Name chatapp_json
          Format json
          Time_Key timestamp
          Time_Format %Y-%m-%dT%H:%M:%S.%fZ

    outputs: |
      [OUTPUT]
          Name es
          Match kube.*
          Host elasticsearch-master-hl
          Port 9200
          Index kubernetes
          HTTP_User elastic
          HTTP_Passwd ${ELASTICSEARCH_PASSWORD}
          tls off
          tls.verify Off
          Suppress_Type_Name On
          Logstash_Format On
          Logstash_Prefix kubernetes
          Logstash_DateFormat %Y.%m.%d
          Replace_Dots On
          Retry_Limit 2
          workers 1
